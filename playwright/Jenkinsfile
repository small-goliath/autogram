pipeline {
    agent any

    triggers {
        cron('0 4 * * 1')
    }

    environment {
        PROJECT_ROOT = "${WORKSPACE}"
        PYTHON_BIN = "${PROJECT_ROOT}/.venv/bin/python"
        COLLECT_SCRIPT = "${PROJECT_ROOT}/playwright/collect_unfollowers.py"
        LOG_DIR = "${PROJECT_ROOT}/logs"
        HEADLESS = 'true'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '31'))
        disableConcurrentBuilds()
    }

    stages {
        stage('체크아웃') {
            steps {
                echo '======================================'
                echo 'Git 저장소 체크아웃'
                echo '======================================'

                script {
                    if (env.GIT_URL) {
                        checkout scm
                    } else if (env.GIT_REPO_URL) {
                        git branch: env.GIT_BRANCH ?: 'main',
                            url: env.GIT_REPO_URL
                    } else {
                        echo 'Git 저장소 정보가 없습니다. Pipeline script from SCM 사용을 권장합니다.'
                        echo '또는 GIT_REPO_URL 환경변수를 설정하세요.'
                    }
                }

                echo '체크아웃 완료'
            }
        }

        stage('환경 설정') {
            steps {
                echo '======================================'
                echo '환경 설정 및 확인'
                echo '======================================'
                echo "프로젝트 루트: ${PROJECT_ROOT}"
                echo "Python 바이너리: ${PYTHON_BIN}"
                echo "스크립트: ${COLLECT_SCRIPT}"
                echo "로그 디렉토리: ${LOG_DIR}"

                script {
                    if (!fileExists("${COLLECT_SCRIPT}")) {
                        error("오류: 스크립트를 찾을 수 없습니다: ${COLLECT_SCRIPT}")
                    }

                    if (!fileExists("${PYTHON_BIN}")) {
                        echo "가상환경을 찾을 수 없습니다. 새로 생성합니다..."
                        sh """
                            cd ${PROJECT_ROOT}
                            python3 -m venv .venv
                            ${PROJECT_ROOT}/.venv/bin/pip install --upgrade pip
                            ${PROJECT_ROOT}/.venv/bin/pip install -r requirements.txt
                        """
                        echo "가상환경 생성 완료"
                    } else {
                        echo "가상환경 확인 완료"
                    }

                    def playwrightInstalled = sh(
                        script: "${PYTHON_BIN} -c 'import playwright; print(\"installed\")' 2>/dev/null || echo 'not_installed'",
                        returnStdout: true
                    ).trim()

                    if (playwrightInstalled == "not_installed" || !fileExists("${env.HOME}/.cache/ms-playwright")) {
                        echo "Playwright 브라우저를 설치합니다..."
                        sh """
                            ${PYTHON_BIN} -m playwright install chromium
                            ${PYTHON_BIN} -m playwright install-deps chromium
                        """
                        echo "Playwright 브라우저 설치 완료"
                    } else {
                        echo "Playwright 브라우저 확인 완료"
                    }
                    sh "mkdir -p ${LOG_DIR}"
                }
            }
        }

        stage('언팔로워 수집 실행') {
            steps {
                script {
                    def timestamp = new Date().format('yyyyMMdd_HHmmss')
                    def logFile = "${LOG_DIR}/unfollower_collection_${timestamp}.log"

                    echo "로그 파일: ${logFile}"

                    sh """
                        cd ${PROJECT_ROOT}
                        ${PYTHON_BIN} ${COLLECT_SCRIPT} 2>&1 | tee ${logFile}
                    """
                }
            }
        }
    }

    post {
        always {
            echo '======================================'
            echo '언팔로워 수집 작업 완료'
            echo "종료 시각: ${new Date()}"
            echo '======================================'

            sh """
                if [ -d "${LOG_DIR}" ]; then
                    find ${LOG_DIR} -name 'unfollower_collection_*.log' -mtime +30 -delete 2>/dev/null || true
                fi
            """
        }

        success {
            echo '언팔로워 수집이 성공적으로 완료되었습니다!'

            script {
                if (env.DISCORD_WEBHOOK_URL) {
                    sh """
                        curl -X POST "${env.DISCORD_WEBHOOK_URL}" \
                          -H "Content-Type: application/json" \
                          -d '{
                            "embeds": [{
                              "title": "✅ 언팔로워 수집 성공",
                              "description": "언팔로워 수집이 성공적으로 완료되었습니다",
                              "color": 5763719,
                              "fields": [
                                {
                                  "name": "빌드 번호",
                                  "value": "#${BUILD_NUMBER}",
                                  "inline": true
                                },
                                {
                                  "name": "실행 시각",
                                  "value": "${new Date()}",
                                  "inline": true
                                }
                              ],
                              "timestamp": "${new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'")}"
                            }]
                          }'
                    """
                }
            }
        }

        failure {
            echo '❌ 언팔로워 수집 중 오류가 발생했습니다'

            script {
                if (env.DISCORD_WEBHOOK_URL) {
                    sh """
                        curl -X POST "${env.DISCORD_WEBHOOK_URL}" \
                          -H "Content-Type: application/json" \
                          -d '{
                            "embeds": [{
                              "title": "❌ 언팔로워 수집 실패",
                              "description": "언팔로워 수집 중 오류가 발생했습니다",
                              "color": 15158332,
                              "fields": [
                                {
                                  "name": "빌드 번호",
                                  "value": "#${BUILD_NUMBER}",
                                  "inline": true
                                },
                                {
                                  "name": "실행 시각",
                                  "value": "${new Date()}",
                                  "inline": true
                                }
                              ],
                              "timestamp": "${new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'")}"
                            }]
                          }'
                    """
                }
            }
        }
    }
}
